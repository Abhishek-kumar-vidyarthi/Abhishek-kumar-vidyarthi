name: Profile Automation â€” Stats, Format, Security

on:
  schedule:
    - cron: "0 6 * * *"    # daily at 06:00 UTC
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  security-events: write
  actions: read

jobs:
  prepare:
    name: Update README + Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 1) Update README (Last Updated + stats)
      # --------------------------------------------------
      - name: Update README
        run: |
          README=README.md
          DATE="$(date -u +'%Y-%m-%d %H:%M UTC')"

          # Add or update "Last Updated"
          if grep -q "^Last Updated:" "$README"; then
            sed -i "s/^Last Updated:.*/Last Updated: $DATE/" "$README"
          else
            awk -v d="$DATE" 'NR==1 {print; if ($0 ~ /^#/) print ""; print "Last Updated: " d; next} {print}' "$README" > tmp.md && mv tmp.md "$README"
          fi

          # Ensure GitHub stats cards exist
          if ! grep -q "github-readme-stats" "$README"; then
            cat >> "$README" <<'EOF'

<!-- GitHub Stats -->
![GitHub Stats](https://github-readme-stats.vercel.app/api?username=Abhishek-kumar-vidyarthi&show_icons=true&theme=dark)

<!-- Top Languages -->
![Top Languages](https://github-readme-stats.vercel.app/api/top-langs/?username=Abhishek-kumar-vidyarthi&layout=compact&theme=dark)

EOF
          fi

      # --------------------------------------------------
      # 2) Run Prettier on README
      # --------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Prettier
        run: npm install --no-save prettier

      - name: Prettify README
        run: npx prettier --write README.md

      # --------------------------------------------------
      # 3) Commit changes
      # --------------------------------------------------
      - name: Commit changes (if any)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Auto-update README (stats + last updated)"
            git push
          else
            echo "No changes to commit."
          fi

  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript,python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Run CodeQL
        uses: github/codeql-action/analyze@v2
